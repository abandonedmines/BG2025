<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>GeoJSON ÏûêÎèô Î°úÎî© ÏßÄÎèÑ</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100vh; }

    #gps-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 999;
      padding: 8px 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      box-shadow: 1px 1px 5px rgba(0,0,0,0.2);
    }

    .slider-wrapper {
      position: relative;
      width: 100%;
      max-width: 400px;
      overflow: hidden;
      text-align: center;
    }

    .slider-wrapper img {
      width: 100%;
      max-height: 400px;
      display: none;
      object-fit: contain;
    }

    .slider-wrapper img.active {
      display: block;
    }

    .slider-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 18px;
      z-index: 10;
    }

    .slider-button.left { left: 5px; }
    .slider-button.right { right: 5px; }
  </style>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=9e36db09e57011893c10d8a46f344a7f&autoload=false"></script>
</head>
<body>
  <button id="gps-btn">üìç ÌòÑÏû¨ ÏúÑÏπò</button>
  <div id="map"></div>

  <script>
    // Î™®Î∞îÏùº Í∞êÏßÄ Ìï®Ïàò
    function isMobile() {
      return /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    kakao.maps.load(function () {
      const map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(36.460980, 127.615083),
        level: 4,
        mapTypeId: kakao.maps.MapTypeId.HYBRID
      });

      const gpsBtn = document.getElementById('gps-btn');
      gpsBtn.addEventListener('click', () => {
        if (!isMobile()) {
          alert("üìµ Ïù¥ Í∏∞Îä•ÏùÄ Î™®Î∞îÏùºÏóêÏÑúÎßå ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.");
          return;
        }

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const loc = new kakao.maps.LatLng(lat, lng);

            map.setCenter(loc);

            new kakao.maps.Marker({
              map,
              position: loc
            });

            const iwContent = `<div style="padding:6px 10px;font-size:14px;">üìç ÌòÑÏû¨ ÏúÑÏπò</div>`;
            const infowindow = new kakao.maps.InfoWindow({
              position: loc,
              content: iwContent
            });
            infowindow.open(map, null);
          }, () => {
            alert("‚ö†Ô∏è ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.");
          });
        } else {
          alert("üö´ Î∏åÎùºÏö∞Ï†ÄÍ∞Ä ÏúÑÏπò Ï†ïÎ≥¥Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.");
        }
      });

      // geojson Ï≤òÎ¶¨
      const geojsonFiles = [
        { file: 'samplingresult_1st.geojson', layerType: 'sampling' },
        { file: 'BG_boundary.geojson', layerType: 'boundary' },
        { file: 'BG_mainflowline.geojson', layerType: 'mainflow' }
      ];

      geojsonFiles.forEach(({ file, layerType }) => {
        fetch(file)
          .then(res => res.json())
          .then(data => drawGeoJSON(data, layerType))
          .catch(err => console.error(`‚ùå ${file} Î°úÎìú Ïã§Ìå®:`, err));
      });

      let openInfoWindow = null;

      function drawGeoJSON(geojson, type = 'default') {
        geojson.features.forEach(feature => {
          const geomType = feature.geometry.type;
          const coords = feature.geometry.coordinates;

          if (geomType === 'Polygon' || geomType === 'MultiPolygon') {
            const polygons = geomType === 'Polygon' ? [coords] : coords;
            polygons.forEach(polygon => {
              polygon.forEach(ring => {
                const path = ring.map(([lng, lat]) => new kakao.maps.LatLng(lat, lng));
                const style = getPolygonStyle(type);
                new kakao.maps.Polygon({
                  path,
                  strokeWeight: style.strokeWeight,
                  strokeColor: style.strokeColor,
                  strokeStyle: style.strokeStyle,
                  fillColor: style.fillColor,
                  fillOpacity: style.fillOpacity
                }).setMap(map);
              });
            });
          }

          if (geomType === 'LineString' || geomType === 'MultiLineString') {
            const lines = geomType === 'LineString' ? [coords] : coords;
            lines.forEach(line => {
              const path = line.map(([lng, lat]) => new kakao.maps.LatLng(lat, lng));
              const style = getLineStyle(type);
              new kakao.maps.Polyline({
                path,
                strokeWeight: style.strokeWeight,
                strokeColor: style.strokeColor,
                strokeOpacity: style.strokeOpacity
              }).setMap(map);
            });
          }

          if (geomType === 'Point') {
            const [lng, lat] = coords;
            const pointPos = new kakao.maps.LatLng(lat, lng);

            if (type === 'sampling') {
              const id = feature.properties?.name;
              const photo_urls = feature.properties?.photo_urls;

              const marker = new kakao.maps.Marker({ position: pointPos });
              marker.setMap(map);

              if (id) {
                const label = new kakao.maps.CustomOverlay({
                  position: pointPos,
                  content: `
                    <div style="
                      background:white;
                      border:2px solid #888;
                      padding:4px 8px;
                      border-radius:6px;
                      font-size:16px;
                      font-weight: bold;
                      transform: translate(10px, -35px);
                      pointer-events: none;
                      box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
                    ">
                      ${id}
                    </div>`,
                  xAnchor: 0,
                  yAnchor: 1
                });
                label.setMap(map);
              }

              if (Array.isArray(photo_urls) && photo_urls.length > 0) {
                const images = photo_urls.map((url, i) =>
                  `<img src="${url}" class="${i === 0 ? 'active' : ''}" />`).join('');

                const sliderContent = `
                  <div style="padding:5px;max-width:420px;">
                    <strong>${id || ''}</strong><br>
                    <div class="slider-wrapper">
                      ${images}
                      <button class="slider-button left" onclick="prevSlide(this)">‚Üê</button>
                      <button class="slider-button right" onclick="nextSlide(this)">‚Üí</button>
                    </div>
                  </div>
                `;

                const infowindow = new kakao.maps.InfoWindow({ content: sliderContent });

                kakao.maps.event.addListener(marker, 'click', function () {
                  if (openInfoWindow) openInfoWindow.close();
                  infowindow.open(map, marker);
                  openInfoWindow = infowindow;
                });
              }
            } else {
              new kakao.maps.Marker({ position: pointPos }).setMap(map);
            }
          }
        });
      }

      function getPolygonStyle(type) {
        if (type === 'boundary') {
          return {
            strokeWeight: 2.5,
            strokeColor: '#FFFF00',
            strokeStyle: 'dash',
            fillColor: 'rgba(0,0,0,0)',
            fillOpacity: 0
          };
        }
        return {
          strokeWeight: 2,
          strokeColor: '#333',
          strokeStyle: 'solid',
          fillColor: '#cccccc',
          fillOpacity: 0.3
        };
      }

      function getLineStyle(type) {
        if (type === 'mainflow') {
          return {
            strokeWeight: 2,
            strokeColor: '#fc0390',
            strokeOpacity: 0.8
          };
        }
        return {
          strokeWeight: 2,
          strokeColor: '#444',
          strokeOpacity: 0.5
        };
      }

      // Ïä¨ÎùºÏù¥Îìú Ï†úÏñ¥ Ìï®Ïàò
      window.nextSlide = function (button) {
        const wrapper = button.parentElement;
        const imgs = wrapper.querySelectorAll('img');
        let current = Array.from(imgs).findIndex(img => img.classList.contains('active'));
        imgs[current].classList.remove('active');
        const next = (current + 1) % imgs.length;
        imgs[next].classList.add('active');
      };

      window.prevSlide = function (button) {
        const wrapper = button.parentElement;
        const imgs = wrapper.querySelectorAll('img');
        let current = Array.from(imgs).findIndex(img => img.classList.contains('active'));
        imgs[current].classList.remove('active');
        const prev = (current - 1 + imgs.length) % imgs.length;
        imgs[prev].classList.add('active');
      };
    });
  </script>
</body>
</html>

